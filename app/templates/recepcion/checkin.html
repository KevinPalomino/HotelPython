{% extends "base.html" %}
{% block title %}Check-in - Hotel Management{% endblock %}
{% block content %}

<div class="breadcrumb">
  <a href="{{ url_for('recepcion.panel_recepcionista') }}">
    <i class="fas fa-concierge-bell"></i> Panel Recepción
  </a>
  <span> / Check-in</span>
</div>

<h1 class="page-title">
  <i class="fas fa-sign-in-alt"></i>
  Check-In
</h1>

<!-- Formulario de filtro por fecha y botones adicionales -->
<div class="card mb-4">
  <div class="card-body">
    <div style="display: flex; justify-content: space-between; align-items: center">
      <!-- Formulario de filtro a la izquierda -->
      <form method="GET" action="{{ url_for('recepcion.ver_reservas_checkin') }}" class="form-inline">
        <div class="form-group mr-2 mb-0">
          <label for="fecha" class="mr-2">Filtrar por fecha:</label>
          <input type="date" id="fecha" name="fecha" class="form-control"
                 value="{{ fecha_filtro if fecha_filtro != 'todas' else '' }}" min="{{ hoy }}" />
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter"></i> Filtrar
        </button>
        <a href="{{ url_for('recepcion.ver_reservas_checkin') }}" class="btn btn-secondary ml-2">
          <i class="fas fa-broom"></i> Limpiar
        </a>
      </form>

      <!-- Botones adicionales a la derecha -->
      <div>
        <a href="{{ url_for('recepcion.ver_reservas_canceladas') }}" class="btn btn-warning mr-2">
          <i class="fas fa-times-circle"></i> Ver Canceladas
        </a>
        <a href="{{ url_for('recepcion.checkin_directo') }}" class="btn btn-info">
          <i class="fas fa-walking"></i> Check-in Directo
        </a>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">
      {% if fecha_filtro == 'todas' %}
        Todas las Reservas Pendientes de Check-in
      {% else %}
        Reservas Pendientes de Check-in para el {{ fecha_filtro }}
      {% endif %}
    </h2>
  </div>

  {% if reservas %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th><i class="fas fa-user"></i> Cliente</th>
          <th><i class="fas fa-bed"></i> Habitación</th>
          <th><i class="fas fa-home"></i> Tipo</th>
          <th><i class="fas fa-calendar-alt"></i> Fecha Ingreso</th>
          <th><i class="fas fa-calendar-alt"></i> Fecha Salida</th>
          <th><i class="fas fa-info-circle"></i> Estado</th>
          <th><i class="fas fa-cogs"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r, h, p in reservas %}
        <tr>
          <td>{{ p.nombre }}</td>
          <td>Habitación {{ h.idhabitaciones }}</td>
          <td>{{ h.tipo }}</td>
          <td>{{ r.checkin.strftime('%Y-%m-%d') }}</td>
          <td>{{ r.checkout.strftime('%Y-%m-%d') }}</td>
          <td>
            {% if r.checkin.strftime('%Y-%m-%d') == hoy %}
            <span class="status-badge" style="background-color: #28a745; color: white">Hoy</span>
            {% else %}
            <span class="status-badge status-pending">Pendiente</span>
            {% endif %}
          </td>
          <td class="actions">
            <a href="{{ url_for('recepcion.hacer_checkin', reserva_id=r.idreservas) }}" class="btn btn-success btn-sm mr-2">
              <i class="fas fa-sign-in-alt"></i> Check-in
            </a>
            <button type="button" class="btn btn-danger btn-sm"
                    data-reserva-id="{{ r.idreservas }}"
                    data-cliente-nombre="{{ p.nombre }}"
                    onclick="mostrarModalCancelacion(this)">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center p-3">
    <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--text-light); margin-bottom: 1rem"></i>
    <p style="color: var(--text-light); font-size: 1.1rem">
      {% if fecha_filtro == 'todas' %}
        No hay reservas pendientes de check-in.
      {% else %}
        No hay reservas pendientes para la fecha seleccionada.
      {% endif %}
    </p>
  </div>
  {% endif %}
</div>

<!-- Modal para cancelar reserva -->
<div id="modalCancelacion" class="modal-overlay" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning"></i> Cancelar Reserva
        </h5>
        <button type="button" class="modal-close" onclick="cerrarModal()">&times;</button>
      </div>
      <form id="formCancelacion" method="POST">
        <div class="modal-body">
          <p>¿Está seguro que desea cancelar la reserva de <strong id="nombreCliente"></strong>?</p>
          <div class="form-group">
            <label for="razon">Razón de la cancelación <span class="text-danger">*</span>:</label>
            <textarea class="form-control" id="razon" name="razon" rows="3"
                      placeholder="Ingrese la razón por la cual se cancela la reserva..." required></textarea>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            <strong>Importante:</strong> Esta acción no se puede deshacer. La reserva pasará al estado de "Cancelada".
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarModal()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-check"></i> Confirmar Cancelación
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- CSS adicional para estilos -->
<style>
  .actions {
    white-space: nowrap;
  }

  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: bold;
  }

  .status-pending {
    background-color: #ffc107;
    color: #212529;
  }

  /* Estilos del modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-dialog {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #aaa;
  }

  .modal-close:hover {
    color: #000;
  }

  .modal-body {
    padding: 1rem;
  }

  .modal-footer {
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .alert {
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    border: 1px solid transparent;
  }

  .alert-warning {
    background-color: #fff3cd;
    border-color: #ffecb5;
    color: #664d03;
  }

  .text-warning {
    color: #f0ad4e;
  }

  .text-danger {
    color: #d9534f;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-control {
    width: 100%;
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 1rem;
  }

  .form-control:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
</style>

<!-- JavaScript para el modal -->
<script>
  function mostrarModalCancelacion(button) {
    // Obtener datos del botón
    const reservaId = button.getAttribute("data-reserva-id");
    const nombreCliente = button.getAttribute("data-cliente-nombre");

    // Establecer la acción del formulario
    document.getElementById("formCancelacion").action =
      "{{ url_for('recepcion.cancelar_reserva', reserva_id=0) }}".replace("0", reservaId);

    // Establecer el nombre del cliente
    document.getElementById("nombreCliente").textContent = nombreCliente;

    // Limpiar el textarea
    document.getElementById("razon").value = "";

    // Mostrar el modal
    document.getElementById("modalCancelacion").style.display = "flex";
  }

  function cerrarModal() {
    document.getElementById("modalCancelacion").style.display = "none";
  }

  // Cerrar modal al hacer clic en el fondo
  document.getElementById("modalCancelacion").addEventListener("click", function(e) {
    if (e.target === this) {
      cerrarModal();
    }
  });

  // Cerrar modal con la tecla Escape
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape" && document.getElementById("modalCancelacion").style.display === "flex") {
      cerrarModal();
    }
  });

  // Validación adicional del formulario
  document.getElementById("formCancelacion").addEventListener("submit", function(e) {
    const razon = document.getElementById("razon").value.trim();
    if (razon.length < 10) {
      e.preventDefault();
      alert("La razón debe tener al menos 10 caracteres.");
      return false;
    }
  });
</script>

{% endblock %}
